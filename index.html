<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åŠ å¯†äº‘å¤‡å¿˜å½•</title>
    <style>
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f7f7f7;
      }
      header {
        padding: 12px 16px;
        background: #ffffff;
        font-weight: 600;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
      }
      textarea {
        width: 100%;
        height: 120px;
        border: none;
        outline: none;
        padding: 16px;
        box-sizing: border-box;
        font-size: 16px;
        resize: none;
      }
      button {
        margin: 12px 16px 0;
        padding: 10px 14px;
        border: none;
        border-radius: 8px;
        background: #000;
        color: #fff;
        font-size: 14px;
        cursor: pointer;
        -webkit-appearance: none; /* è§£å†³ iOS æŒ‰é’®æ ·å¼é—®é¢˜ */
      }
      ul {
        list-style: none;
        padding: 0;
        margin: 12px 0 0;
      }
      li {
        background: #fff;
        margin: 8px 12px;
        padding: 12px;
        border-radius: 10px;
        font-size: 14px;
        cursor: pointer;
      }
      time {
        display: block;
        margin-top: 6px;
        font-size: 12px;
        color: #999;
      }
      .lock {
        color: #666;
        font-style: italic;
      }
      /* å¼¹çª—æ ·å¼ */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal-content {
        background: white;
        padding: 20px;
        border-radius: 10px;
        width: 85%;
        max-width: 400px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .modal-content h3 {
        margin-top: 0;
        font-size: 16px;
      }
      .modal-content input {
        width: 100%;
        padding: 8px;
        margin-bottom: 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 14px;
      }
      .modal-content button {
        width: 100%;
        margin: 0;
      }
      /* å†…å®¹å±•ç¤ºå¼¹çª—ä¸“å±æ ·å¼ */
      #content-display {
        white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œå’Œç©ºæ ¼ */
        word-wrap: break-word; /* è‡ªåŠ¨æ¢è¡Œ */
        max-height: 50vh; /* æœ€å¤§é«˜åº¦ä¸ºå±å¹•çš„ä¸€åŠ */
        overflow-y: auto; /* è¶…å‡ºåˆ™æ»šåŠ¨ */
        padding: 10px;
        background: #f9f9f9;
        border: 1px solid #eee;
        border-radius: 5px;
        margin-bottom: 15px;
      }
      #content-editor {
        width: 100%;
        height: 50vh;
        max-height: 300px;
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 14px;
        resize: vertical;
      }
      .modal-buttons {
        display: flex;
        gap: 10px; /* æŒ‰é’®é—´è· */
      }
    </style>
  </head>
  <body>
    <header>ğŸ” åŠ å¯†äº‘å¤‡å¿˜å½•</header>

    <textarea id="input" placeholder="å†™å®Œåå°†è¢«åŠ å¯†ä¿å­˜..."></textarea>
    <button id="save-button">åŠ å¯†ä¿å­˜</button>

    <ul id="list"></ul>

    <!-- å¯†ç è¾“å…¥å¼¹çª— -->
    <div id="password-modal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <h3>è¯·è¾“å…¥å¯†ç </h3>
        <input type="password" id="password-input" placeholder="é¦–æ¬¡è¾“å…¥å³ä¸ºè®¾ç½®å¯†ç " />
        <button id="password-submit">ç¡®è®¤</button>
      </div>
    </div>

    <!-- å†…å®¹å±•ç¤º/ç¼–è¾‘å¼¹çª— -->
    <div id="content-modal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <h3 id="content-modal-title">è§£å¯†åçš„å†…å®¹</h3>
        <div id="content-display"></div>
        <textarea id="content-editor" style="display: none"></textarea>
        <div class="modal-buttons">
          <button id="copy-button">å¤åˆ¶</button>
          <button id="edit-save-button">ç¼–è¾‘</button>
          <button id="close-button" style="background-color: #6c757d">å…³é—­</button>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/localforage/dist/localforage.js"></script>
    <script>
      const STORAGE_KEY = "secure_notes";
      const SALT_KEY = "secure_notes_salt";

      localforage.config({
        name: "secure-memo",
        storeName: "notes",
      });

      /* ================= å¯†ç å¼¹çª— ================= */
      function showPasswordPrompt() {
        return new Promise((resolve) => {
          const modal = document.getElementById("password-modal");
          const input = document.getElementById("password-input");
          const submitBtn = document.getElementById("password-submit");

          modal.style.display = "flex";
          input.focus();
          input.value = "";

          const onConfirm = () => {
            const pwd = input.value;
            if (pwd) {
              modal.style.display = "none";
              submitBtn.removeEventListener("click", onConfirm);
              document.removeEventListener("keydown", onKeydown);
              resolve(pwd);
            }
          };

          const onKeydown = (e) => {
            if (e.key === "Enter") onConfirm();
          };

          submitBtn.addEventListener("click", onConfirm);
          document.addEventListener("keydown", onKeydown);
        });
      }

      /* ================= å†…å®¹å±•ç¤ºä¸ç¼–è¾‘å¼¹çª— (æ–°) ================= */
      function showContentModal(initialText, noteId) {
        const modal = document.getElementById("content-modal");
        const title = document.getElementById("content-modal-title");
        const contentDisplay = document.getElementById("content-display");
        const contentEditor = document.getElementById("content-editor");
        const copyBtn = document.getElementById("copy-button");
        const editSaveBtn = document.getElementById("edit-save-button");
        const closeBtn = document.getElementById("close-button");

        let isEditing = false;

        // é‡ç½®çŠ¶æ€
        const setDisplayMode = (text) => {
          isEditing = false;
          title.textContent = "è§£å¯†åçš„å†…å®¹";
          contentDisplay.textContent = text;
          contentEditor.value = text;
          contentDisplay.style.display = "block";
          contentEditor.style.display = "none";
          editSaveBtn.textContent = "ç¼–è¾‘";
          editSaveBtn.style.backgroundColor = "#000";
          copyBtn.style.display = "block";
        };

        const setEditMode = () => {
          isEditing = true;
          title.textContent = "æ­£åœ¨ç¼–è¾‘";
          contentDisplay.style.display = "none";
          contentEditor.style.display = "block";
          editSaveBtn.textContent = "ä¿å­˜";
          editSaveBtn.style.backgroundColor = "#28a745"; // ç»¿è‰²
          copyBtn.style.display = "none";
          contentEditor.focus();
        };

        setDisplayMode(initialText);
        modal.style.display = "flex";

        const cleanup = () => {
          copyBtn.removeEventListener("click", onCopy);
          editSaveBtn.removeEventListener("click", onEditSave);
          closeBtn.removeEventListener("click", onClose);
        };

        const onClose = () => {
          modal.style.display = "none";
          cleanup();
        };

        const onCopy = () => {
          navigator.clipboard.writeText(contentDisplay.textContent).then(() => {
            copyBtn.textContent = "å·²å¤åˆ¶!";
            setTimeout(() => {
              copyBtn.textContent = "å¤åˆ¶";
            }, 2000);
          });
        };

        const onEditSave = async () => {
          if (!isEditing) {
            setEditMode();
          } else {
            const newText = contentEditor.value.trim();

            if (newText === "") {
              const notes = await loadNotes();
              const updatedNotes = notes.filter((note) => note.id !== noteId);
              await saveNotes(updatedNotes);
              onClose();
              render();
              return;
            }

            try {
              const pwd = await getPassword();
              const key = await getKey(pwd);
              const newPayload = await encrypt(newText, key);

              const notes = await loadNotes();
              const noteIndex = notes.findIndex((note) => note.id === noteId);
              if (noteIndex > -1) {
                notes[noteIndex].payload = newPayload;
                await saveNotes(notes);
                render();
              }
              setDisplayMode(newText);
            } catch (e) {
              console.error("ä¿å­˜å¤±è´¥:", e);
              alert("ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
          }
        };

        copyBtn.addEventListener("click", onCopy);
        editSaveBtn.addEventListener("click", onEditSave);
        closeBtn.addEventListener("click", onClose);
      }

      /* ================= å¯†ç  ================= */
      async function getPassword() {
        let pwd = sessionStorage.getItem("note_pwd");
        if (!pwd) {
          pwd = await showPasswordPrompt();
          if (!pwd) throw new Error("éœ€è¦å¯†ç ");
          sessionStorage.setItem("note_pwd", pwd);
        }
        return pwd;
      }

      /* ================= Key æ´¾ç”Ÿ ================= */
      async function getKey(password) {
        let salt = await localforage.getItem(SALT_KEY);

        if (!salt) {
          salt = crypto.getRandomValues(new Uint8Array(16));
          await localforage.setItem(SALT_KEY, salt);
        }

        if (salt instanceof ArrayBuffer) {
          salt = new Uint8Array(salt);
        } else if (Array.isArray(salt)) {
          salt = new Uint8Array(salt);
        }

        const baseKey = await crypto.subtle.importKey("raw", new TextEncoder().encode(password), "PBKDF2", false, ["deriveKey"]);

        return crypto.subtle.deriveKey(
          {
            name: "PBKDF2",
            salt,
            iterations: 100000,
            hash: "SHA-256",
          },
          baseKey,
          { name: "AES-GCM", length: 256 },
          false,
          ["encrypt", "decrypt"]
        );
      }

      /* ================= åŠ è§£å¯† ================= */
      async function encrypt(text, key) {
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const data = new TextEncoder().encode(text);
        const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, data);

        return {
          iv: btoa(String.fromCharCode(...iv)),
          data: btoa(String.fromCharCode(...new Uint8Array(encrypted))),
        };
      }

      async function decrypt(payload, key) {
        const iv = Uint8Array.from(atob(payload.iv), (c) => c.charCodeAt(0));
        const data = Uint8Array.from(atob(payload.data), (c) => c.charCodeAt(0));
        const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, data);
        return new TextDecoder().decode(decrypted);
      }

      /* ================= æ•°æ® ================= */
      async function loadNotes() {
        return (await localforage.getItem(STORAGE_KEY)) || [];
      }

      async function saveNotes(notes) {
        await localforage.setItem(STORAGE_KEY, notes);
      }

      async function render() {
        const list = document.getElementById("list");
        const notes = await loadNotes();
        list.innerHTML = "";

        notes.sort((a, b) => b.time - a.time);

        for (const n of notes) {
          const li = document.createElement("li");
          li.innerHTML = `<span class="lock">ğŸ”’ ç‚¹å‡»è§£å¯†æŸ¥çœ‹</span><time>${new Date(n.time).toLocaleString()}</time>`;
          li.onclick = async () => {
            try {
              const pwd = await getPassword();
              const key = await getKey(pwd);
              const text = await decrypt(n.payload, key);
              showContentModal(text, n.id);
            } catch (e) {
              console.error(e);
              alert("å¯†ç é”™è¯¯æˆ–è§£å¯†å¤±è´¥");
              sessionStorage.removeItem("note_pwd");
            }
          };
          list.appendChild(li);
        }
      }

      /* ================= æ–°å¢å¤‡å¿˜å½• ================= */
      async function addNote() {
        const input = document.getElementById("input");
        const text = input.value.trim();
        if (!text) return;

        try {
          const pwd = await getPassword();
          const key = await getKey(pwd);
          const payload = await encrypt(text, key);

          const notes = await loadNotes();
          notes.push({
            id: Date.now(),
            payload,
            time: Date.now(),
          });

          await saveNotes(notes);
          input.value = "";
          render();
        } catch (e) {
          console.error(e);
          alert("åŠ å¯†å¤±è´¥ï¼Œè¯·é‡è¯•");
        }
      }

      // åˆå§‹åŒ–
      document.getElementById("save-button").addEventListener("click", addNote);
      render();
    </script>
  </body>
</html>
