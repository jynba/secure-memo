<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åŠ å¯†äº‘å¤‡å¿˜å½•</title>
    <style>
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f7f7f7;
      }
      header {
        padding: 12px 16px;
        background: #ffffff;
        font-weight: 600;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
      }
      textarea {
        width: 100%;
        height: 120px;
        border: none;
        outline: none;
        padding: 16px;
        box-sizing: border-box;
        font-size: 16px;
        resize: none;
      }
      button {
        margin: 12px 16px 0;
        padding: 10px 14px;
        border: none;
        border-radius: 8px;
        background: #000;
        color: #fff;
        font-size: 14px;
        cursor: pointer;
        -webkit-appearance: none; /* è§£å†³ iOS æŒ‰é’®æ ·å¼é—®é¢˜ */
      }
      ul {
        list-style: none;
        padding: 0;
        margin: 12px 0 0;
      }
      li {
        background: #fff;
        margin: 8px 12px;
        padding: 12px;
        border-radius: 10px;
        font-size: 14px;
        cursor: pointer;
      }
      time {
        display: block;
        margin-top: 6px;
        font-size: 12px;
        color: #999;
      }
      .lock {
        color: #666;
        font-style: italic;
      }
      /* å¼¹çª—æ ·å¼ */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal-content {
        background: white;
        padding: 20px;
        border-radius: 10px;
        width: 85%;
        max-width: 400px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .modal-content h3 {
        margin-top: 0;
        font-size: 16px;
      }
      .modal-content input {
        width: 100%;
        padding: 8px;
        margin-bottom: 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 14px;
      }
      .modal-content button {
        width: 100%;
        margin: 0;
      }
      /* å†…å®¹å±•ç¤ºå¼¹çª—ä¸“å±æ ·å¼ */
      #content-display {
        white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œå’Œç©ºæ ¼ */
        word-wrap: break-word; /* è‡ªåŠ¨æ¢è¡Œ */
        max-height: 50vh; /* æœ€å¤§é«˜åº¦ä¸ºå±å¹•çš„ä¸€åŠ */
        overflow-y: auto; /* è¶…å‡ºåˆ™æ»šåŠ¨ */
        padding: 10px;
        background: #f9f9f9;
        border: 1px solid #eee;
        border-radius: 5px;
        margin-bottom: 15px;
      }
      #content-editor {
        width: 100%;
        height: 50vh;
        max-height: 300px;
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 14px;
        resize: vertical;
      }
      .modal-buttons {
        display: flex;
        gap: 10px; /* æŒ‰é’®é—´è· */
      }
    </style>
  </head>
  <body>
    <header>ğŸ” åŠ å¯†äº‘å¤‡å¿˜å½•</header>

    <textarea id="input" placeholder="å†™å®Œåå°†è¢«åŠ å¯†ä¿å­˜..."></textarea>
    <button id="save-button">åŠ å¯†ä¿å­˜</button>

    <ul id="list"></ul>

    <!-- å¯†ç è¾“å…¥å¼¹çª— -->
    <div id="password-modal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <h3 id="password-modal-title">è¯·è¾“å…¥å¯†ç </h3>
        <input type="password" id="password-input" placeholder="é¦–æ¬¡è¾“å…¥å³ä¸ºè®¾ç½®å¯†ç " />
        <button id="password-submit">ç¡®è®¤</button>
      </div>
    </div>

    <!-- å†…å®¹å±•ç¤º/ç¼–è¾‘å¼¹çª— -->
    <div id="content-modal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <h3 id="content-modal-title">è§£å¯†åçš„å†…å®¹</h3>
        <div id="content-display"></div>
        <textarea id="content-editor" style="display: none"></textarea>
        <div class="modal-buttons">
          <button id="copy-button">å¤åˆ¶</button>
          <button id="edit-save-button">ç¼–è¾‘</button>
          <button id="close-button" style="background-color: #6c757d">å…³é—­</button>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/localforage/dist/localforage.js"></script>
    <script>
      const STORAGE_KEY = "secure_notes";
      const PWD_VERIFIER_KEY = "pwd_verifier";
      const PWD_VERIFIER_TEXT = "password_correct";

      localforage.config({
        name: "secure-memo",
        storeName: "notes",
      });

      /* ================= å¯†ç å¼¹çª— ================= */
      function showPasswordPrompt(isSettingPassword) {
        return new Promise((resolve, reject) => {
          const modal = document.getElementById("password-modal");
          const title = document.getElementById("password-modal-title");
          const input = document.getElementById("password-input");
          const submitBtn = document.getElementById("password-submit");

          title.textContent = isSettingPassword ? "è¯·è®¾ç½®æ‚¨çš„å¯†ç " : "è¯·è¾“å…¥å¯†ç ";
          input.placeholder = isSettingPassword ? "è®¾ç½®åè¯·åŠ¡å¿…ç‰¢è®°" : "";

          modal.style.display = "flex";
          input.focus();
          input.value = "";

          const cleanup = () => {
            modal.style.display = "none";
            submitBtn.removeEventListener("click", onConfirm);
            document.removeEventListener("keydown", onKeydown);
          };

          const onConfirm = () => {
            const pwd = input.value;
            if (pwd) {
              cleanup();
              resolve(pwd);
            } else {
              cleanup();
              reject(new Error("å¯†ç ä¸èƒ½ä¸ºç©º"));
            }
          };

          const onKeydown = (e) => {
            if (e.key === "Enter") onConfirm();
          };

          submitBtn.addEventListener("click", onConfirm);
          document.addEventListener("keydown", onKeydown);
        });
      }

      /* ================= å†…å®¹å±•ç¤ºä¸ç¼–è¾‘å¼¹çª— ================= */
      function showContentModal(initialText, noteId) {
        const modal = document.getElementById("content-modal");
        const title = document.getElementById("content-modal-title");
        const contentDisplay = document.getElementById("content-display");
        const contentEditor = document.getElementById("content-editor");
        const copyBtn = document.getElementById("copy-button");
        const editSaveBtn = document.getElementById("edit-save-button");
        const closeBtn = document.getElementById("close-button");

        let isEditing = false;

        const setDisplayMode = (text) => {
          isEditing = false;
          title.textContent = "è§£å¯†åçš„å†…å®¹";
          contentDisplay.textContent = text;
          contentEditor.value = text;
          contentDisplay.style.display = "block";
          contentEditor.style.display = "none";
          editSaveBtn.textContent = "ç¼–è¾‘";
          editSaveBtn.style.backgroundColor = "#000";
          copyBtn.style.display = "block";
        };

        const setEditMode = () => {
          isEditing = true;
          title.textContent = "æ­£åœ¨ç¼–è¾‘";
          contentDisplay.style.display = "none";
          contentEditor.style.display = "block";
          editSaveBtn.textContent = "ä¿å­˜";
          editSaveBtn.style.backgroundColor = "#28a745"; // ç»¿è‰²
          copyBtn.style.display = "none";
          contentEditor.focus();
        };

        setDisplayMode(initialText);
        modal.style.display = "flex";

        const cleanup = () => {
          copyBtn.removeEventListener("click", onCopy);
          editSaveBtn.removeEventListener("click", onEditSave);
          closeBtn.removeEventListener("click", onClose);
        };

        const onClose = () => {
          modal.style.display = "none";
          cleanup();
        };

        const onCopy = () => {
          navigator.clipboard.writeText(contentDisplay.textContent).then(() => {
            copyBtn.textContent = "å·²å¤åˆ¶!";
            setTimeout(() => {
              copyBtn.textContent = "å¤åˆ¶";
            }, 2000);
          });
        };

        const onEditSave = async () => {
          if (!isEditing) {
            setEditMode();
          } else {
            const newText = contentEditor.value.trim();

            if (newText === "") {
              const notes = await loadNotes();
              const updatedNotes = notes.filter((note) => note.id !== noteId);
              await saveNotes(updatedNotes);
              onClose();
              render();
              return;
            }

            try {
              const pwd = await getPassword();
              const newPayload = simpleEncrypt(newText, pwd);

              const notes = await loadNotes();
              const noteIndex = notes.findIndex((note) => note.id === noteId);
              if (noteIndex > -1) {
                notes[noteIndex].payload = newPayload;
                await saveNotes(notes);
                render();
              }
              setDisplayMode(newText);
            } catch (e) {
              console.error("ä¿å­˜å¤±è´¥:", e);
              alert("ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
          }
        };

        copyBtn.addEventListener("click", onCopy);
        editSaveBtn.addEventListener("click", onEditSave);
        closeBtn.addEventListener("click", onClose);
      }

      /* ================= å¯†ç  ================= */
      async function getPassword() {
        let pwd = sessionStorage.getItem("note_pwd");
        if (pwd) return pwd;

        const verifier = await localforage.getItem(PWD_VERIFIER_KEY);
        const isSettingPassword = !verifier;

        const enteredPwd = await showPasswordPrompt(isSettingPassword);

        if (isSettingPassword) {
          const newVerifier = simpleEncrypt(PWD_VERIFIER_TEXT, enteredPwd);
          await localforage.setItem(PWD_VERIFIER_KEY, newVerifier);
          sessionStorage.setItem("note_pwd", enteredPwd);
          return enteredPwd;
        } else {
          try {
            const decrypted = simpleDecrypt(verifier, enteredPwd);
            if (decrypted === PWD_VERIFIER_TEXT) {
              sessionStorage.setItem("note_pwd", enteredPwd);
              return enteredPwd;
            } else {
              throw new Error("å¯†ç é”™è¯¯");
            }
          } catch (e) {
            throw new Error("å¯†ç é”™è¯¯");
          }
        }
      }

      /* ================= åŠ è§£å¯† (ç®€å•ç‰ˆ) ================= */
      function simpleEncrypt(text, key) {
        let result = "";
        for (let i = 0; i < text.length; i++) {
          const charCode = text.charCodeAt(i) ^ key.charCodeAt(i % key.length);
          result += String.fromCharCode(charCode);
        }
        return btoa(encodeURIComponent(result));
      }

      function simpleDecrypt(encryptedText, key) {
        const decodedText = decodeURIComponent(atob(encryptedText));
        let result = "";
        for (let i = 0; i < decodedText.length; i++) {
          const charCode = decodedText.charCodeAt(i) ^ key.charCodeAt(i % key.length);
          result += String.fromCharCode(charCode);
        }
        return result;
      }

      /* ================= æ•°æ® ================= */
      async function loadNotes() {
        return (await localforage.getItem(STORAGE_KEY)) || [];
      }

      async function saveNotes(notes) {
        await localforage.setItem(STORAGE_KEY, notes);
      }

      async function render() {
        const list = document.getElementById("list");
        const notes = await loadNotes();
        list.innerHTML = "";

        notes.sort((a, b) => b.time - a.time);

        for (const n of notes) {
          const li = document.createElement("li");
          li.innerHTML = `<span class="lock">ğŸ”’ ç‚¹å‡»è§£å¯†æŸ¥çœ‹</span><time>${new Date(n.time).toLocaleString()}</time>`;
          li.onclick = async () => {
            try {
              const pwd = await getPassword();
              const text = simpleDecrypt(n.payload, pwd);
              showContentModal(text, n.id);
            } catch (e) {
              console.error(e);
              alert(e.message || "è§£å¯†å¤±è´¥");
              sessionStorage.removeItem("note_pwd");
            }
          };
          list.appendChild(li);
        }
      }

      /* ================= æ–°å¢å¤‡å¿˜å½• ================= */
      async function addNote() {
        const input = document.getElementById("input");
        const text = input.value.trim();
        if (!text) return;

        try {
          const pwd = await getPassword();
          const payload = simpleEncrypt(text, pwd);

          const notes = await loadNotes();
          notes.push({
            id: Date.now(),
            payload,
            time: Date.now(),
          });

          await saveNotes(notes);
          input.value = "";
          render();
        } catch (e) {
          console.error(e);
          alert(e.message || "åŠ å¯†å¤±è´¥ï¼Œè¯·é‡è¯•");
          sessionStorage.removeItem("note_pwd");
        }
      }

      // åˆå§‹åŒ–
      document.getElementById("save-button").addEventListener("click", addNote);
      render();
    </script>
  </body>
</html>
