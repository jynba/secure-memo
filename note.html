<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åŠ å¯†äº‘å¤‡å¿˜å½•</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f7f7f7;
    }
    header {
      padding: 12px 16px;
      background: #ffffff;
      font-weight: 600;
      box-shadow: 0 1px 4px rgba(0,0,0,.06);
    }
    textarea {
      width: 100%;
      height: 120px;
      border: none;
      outline: none;
      padding: 16px;
      box-sizing: border-box;
      font-size: 16px;
      resize: none;
    }
    button {
      margin: 12px 16px 0;
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      background: #000;
      color: #fff;
      font-size: 14px;
    }
    ul {
      list-style: none;
      padding: 0;
      margin: 12px 0 0;
    }
    li {
      background: #fff;
      margin: 8px 12px;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
    }
    time {
      display: block;
      margin-top: 6px;
      font-size: 12px;
      color: #999;
    }
    .lock {
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <header>ğŸ” åŠ å¯†äº‘å¤‡å¿˜å½•</header>

  <textarea id="input" placeholder="å†™å®Œåå°†è¢«åŠ å¯†ä¿å­˜..."></textarea>
  <button onclick="addNote()">åŠ å¯†ä¿å­˜</button>

  <ul id="list"></ul>

  <script src="https://unpkg.com/localforage/dist/localforage.js"></script>
  <script>
    const STORAGE_KEY = 'secure_notes';
    const SALT_KEY = 'secure_notes_salt';

    localforage.config({
      name: 'secure-memo',
      storeName: 'notes'
    });

    /* ================= å¯†ç  ================= */
    async function getPassword() {
      let pwd = sessionStorage.getItem('note_pwd');
      if (!pwd) {
        pwd = prompt('è¯·è¾“å…¥è§£å¯†å¯†ç ï¼ˆé¦–æ¬¡å³ä¸ºè®¾ç½®å¯†ç ï¼‰');
        if (!pwd) throw new Error('éœ€è¦å¯†ç ');
        sessionStorage.setItem('note_pwd', pwd);
      }
      return pwd;
    }

    /* ================= Key æ´¾ç”Ÿï¼ˆä¿®å¤ç‰ˆï¼‰ ================= */
    async function getKey(password) {
      let salt = await localforage.getItem(SALT_KEY);

      if (!salt) {
        salt = crypto.getRandomValues(new Uint8Array(16));
        await localforage.setItem(SALT_KEY, salt);
      }

      // å…¼å®¹ localForage ä¸åŒ driver çš„è¿”å›ç±»å‹
      if (salt instanceof ArrayBuffer) {
        salt = new Uint8Array(salt);
      } else if (Array.isArray(salt)) {
        salt = new Uint8Array(salt);
      }

      const baseKey = await crypto.subtle.importKey(
        'raw',
        new TextEncoder().encode(password),
        'PBKDF2',
        false,
        ['deriveKey']
      );

      return crypto.subtle.deriveKey(
        {
          name: 'PBKDF2',
          salt,
          iterations: 100000,
          hash: 'SHA-256'
        },
        baseKey,
        { name: 'AES-GCM', length: 256 },
        false,
        ['encrypt', 'decrypt']
      );
    }

    /* ================= åŠ è§£å¯† ================= */
    async function encrypt(text, key) {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const data = new TextEncoder().encode(text);
      const encrypted = await crypto.subtle.encrypt(
        { name: 'AES-GCM', iv },
        key,
        data
      );

      return {
        iv: btoa(String.fromCharCode(...iv)),
        data: btoa(String.fromCharCode(...new Uint8Array(encrypted)))
      };
    }

    async function decrypt(payload, key) {
      const iv = Uint8Array.from(atob(payload.iv), c => c.charCodeAt(0));
      const data = Uint8Array.from(atob(payload.data), c => c.charCodeAt(0));
      const decrypted = await crypto.subtle.decrypt(
        { name: 'AES-GCM', iv },
        key,
        data
      );
      return new TextDecoder().decode(decrypted);
    }

    /* ================= æ•°æ® ================= */
    async function loadNotes() {
      return (await localforage.getItem(STORAGE_KEY)) || [];
    }

    async function saveNotes(notes) {
      await localforage.setItem(STORAGE_KEY, notes);
    }

    async function render() {
      const list = document.getElementById('list');
      const notes = await loadNotes();
      list.innerHTML = '';

      notes.sort((a, b) => b.time - a.time);

      for (const n of notes) {
        const li = document.createElement('li');
        li.innerHTML = `<span class="lock">ğŸ”’ ç‚¹å‡»è§£å¯†æŸ¥çœ‹</span><time>${new Date(n.time).toLocaleString()}</time>`;
        li.onclick = async () => {
          try {
            const pwd = await getPassword();
            const key = await getKey(pwd);
            const text = await decrypt(n.payload, key);
            alert(text);
          } catch (e) {
            alert('å¯†ç é”™è¯¯æˆ–è§£å¯†å¤±è´¥');
          }
        };
        list.appendChild(li);
      }
    }

    /* ================= æ–°å¢å¤‡å¿˜å½• ================= */
    async function addNote() {
      const input = document.getElementById('input');
      const text = input.value.trim();
      if (!text) return;

      const pwd = await getPassword();
      const key = await getKey(pwd);
      const payload = await encrypt(text, key);

      const notes = await loadNotes();
      notes.push({
        id: Date.now(),
        payload,
        time: Date.now()
      });

      await saveNotes(notes);
      input.value = '';
      render();
    }

    // åˆå§‹åŒ–æ¸²æŸ“
    render();
  </script>
</body>
</html>